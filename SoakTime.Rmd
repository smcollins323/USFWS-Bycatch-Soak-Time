---
title: "Soak Time and Duration"
author: "Jessika Lamarre, Robert Blackmore, Sydney Collins"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Load packages and Data}
library(tidyverse)
library(rstatix)
library(ggpubr)
library(emmeans)
library(DHARMa)
library(glmmTMB)
library(lubridate)
library(data.table)
library(doBy)

#Setting up main datasets
metadata <- read.csv("data/Soak_time_metadata_2024.csv")

main.data <- read.csv("data/Main_herring_2024_Catch_Bycatch.csv") %>%
  left_join(metadata %>% dplyr::select(Trip_ID, Prevailing_weather_cond.1))


morpho.data <- read.csv("data/Herring_morphometrics_2024.csv") %>%
  drop_na()

summaryBy(Weight ~ Port, data = morpho.data)

#Subset
sum.data <- subset(main.data, main.data$Net_group=="Sum") %>% #sum of both nets
  mutate(Total_target_catch_kg = as.numeric(Total_target_catch_kg)) %>%
  mutate(Total_target_catch_number = as.numeric(Total_target_catch_number)) %>%
  mutate(Total_target_catch_kg = ifelse(is.na(Total_target_catch_kg) == T & Port == "Baie_de_Verde", (Total_target_catch_number*271)/1000, Total_target_catch_kg)) %>%
  mutate(NOGA_presence = as.numeric(NOGA_presence)) %>%
  mutate(scaled_catch = Total_target_catch_number/Net_area_m2) %>%
  mutate(scaled_weight = (Total_target_catch_kg/Net_area_m2) + 0.00001) %>%
  mutate(Date_pulling = as.Date(Date_pulling, format = "%m/%d/%Y")) %>%
  mutate(Time_setting = as.POSIXct(Time_setting, format = "%m/%d/%Y %H:%M:%S")) %>%
  mutate(Time_pulling = as.POSIXct(Time_pulling, format = "%m/%d/%Y %H:%M:%S")) %>%
  mutate(yDate = yday(Date_pulling)) %>%
  mutate(bycatch = ifelse(Bycatch_Sculpin != 0 | Bycatch_Salmon != 0 | 
                          Bycatch_NOGA != 0 | Bycatch_Rock_Crab != 0 |
                          Bycatch_Atlantic_Cod != 0 | Bycatch_Sea_Trout != 0 |
                          Bycatch_Flounder != 0, 1, 0)) %>%
  mutate(bycatch_sum = Bycatch_Sculpin + Bycatch_Salmon + Bycatch_NOGA +
           Bycatch_Rock_Crab + Bycatch_Atlantic_Cod + Bycatch_Sea_Trout +
                          Bycatch_Flounder) %>%
  mutate(Soak_duration = as.numeric(Time_pulling - Time_setting)) %>%
  mutate(Net_treatment = factor(Net_treatment, levels = c("24hr", "12_night", "12_day"))) %>%
  mutate(Birds = rowSums(.[22:39])) %>%
  mutate(BirdTime = ifelse((as.ITime(Time_pulling) < 43200) == TRUE, "Morning", "Afternoon")) %>%
  mutate(weather = ifelse(Prevailing_weather_cond.1 %like% "fog" == TRUE | Prevailing_weather_cond.1 %like% "Fog" == TRUE, "fog", "NOfog"))
```

```{r Summary Stats}
#Descriptive stats
sum.data %>%
  group_by(Net_treatment) %>%
  get_summary_stats(Total_target_catch_number, type = "mean_sd")
 
tapply(sum.data$Total_target_catch_number, sum.data$Net_treatment, summary)
tapply(sum.data$Soak_duration, sum.data$Net_treatment, summary)
tapply(as.ITime(sum.data$Time_setting), sum.data$Net_treatment, sum.data$Port, summary)
summaryBy(Total_target_catch_number ~ Net_treatment + Port, data = sum.data, FUN = length)
summary(as.factor(sum.data$Net_treatment))

aggregate(sum.data$Total_target_catch_number, list(sum.data$Net_treatment), FUN=mean)
aggregate(sum.data$Total_target_catch_number, list(sum.data$Net_treatment), FUN=sd)
```

```{r Catch Model}
#Check assumptions ANOVA for Catch weight
jpeg(filename = "figures/CatchBoxplots.jpeg", width = 16, height = 11, units = "cm", res = 300)
ggplot(sum.data, aes(x = Net_treatment, y = scaled_weight)) +
  geom_boxplot(fill = "lightgrey") +
  labs(x = "Net Treatment", y = bquote("Catch Weight" ~(kg/m^2))) +
  scale_x_discrete(labels = c('Control','Reduced Night','Reduced Day')) +
  theme_classic()
dev.off()

#Create the model
mod <- glmmTMB(sqrt(scaled_weight) ~ Net_treatment + Port + yDate, data = sum.data,
               family = gaussian(link = "identity"))
simulateResiduals(mod, plot = T) #looks good!
summary(mod)
Anova(mod)

#Post-hoc test
emmeans(mod, "Net_treatment")
pairs(emmeans(mod, "Net_treatment"))
```

```{r Bycatch Model}
sum.data.na <- sum.data %>% drop_na(Soak_duration)

#logistic regression
logit_bycatchmod <- glmmTMB(bycatch ~ Soak_duration + yDate + Port, data = sum.data,
                            family = binomial(link = "logit"))
sim2 <- simulateResiduals(logit_bycatchmod, plot = T)
testZeroInflation(sim2)
summary(logit_bycatchmod)

library(brglm)
brglm_bycatch <- brglm(bycatch ~ Soak_duration + yDate + Port + Total_target_catch_kg, data = sum.data,
                       family = binomial)
simulateResiduals(brglm_bycatch, plot = T)
summary(brglm_bycatch)

#poisson regression
bycatchmod <- glmmTMB(bycatch_sum ~ Soak_duration + Port + yDate, data = sum.data, 
                      family = poisson(link = "log"), ziformula = ~ Soak_duration)
sim3 <- simulateResiduals(bycatchmod, plot = T)
testZeroInflation(sim3)
plotResiduals(sim3, sum.data.na$Soak_duration)
plotResiduals(sim3, sum.data.na$Port)
plotResiduals(sim3, sum.data.na$yDate)
summary(bycatchmod)
```

```{r Bird Occurrence Model}
boxplot(Birds ~ BirdTime, data = sum.data)

jpeg(filename = "figures/BirdsBoxplot.jpeg", width = 16, height = 11, units = "cm", res = 300)
ggplot(data = sum.data, aes(x = BirdTime, y = Birds)) +
  geom_boxplot(fill = "lightgrey") +
  xlab("Set/Haul Time") +
  ylab("Number of Birds") +
  theme_classic()
dev.off()

birdmod1 <- glmmTMB(Birds ~ BirdTime + Port + yDate + weather + scaled_weight, data = sum.data, 
                   family = nbinom2(link = "log")) #not sure whether to include scaled_weight
birdmod2 <- glmmTMB(Birds ~ BirdTime + Port + yDate + weather, data = sum.data, 
                   family = nbinom2(link = "log"))
birdmod3 <- glmmTMB(Birds ~ BirdTime + Port + yDate + scaled_weight, data = sum.data, 
                   family = nbinom2(link = "log"))
birdmod4 <- glmmTMB(Birds ~ BirdTime + Port + yDate, data = sum.data, 
                   family = nbinom2(link = "log"))
#need to figure out a weather variable
anova(birdmod1, birdmod2, birdmod3, birdmod4)
anova(birdmod2, birdmod3, birdmod4)
anova(birdmod3, birdmod4)
simulateResiduals(birdmod3, plot = T)
summary(birdmod3)
```